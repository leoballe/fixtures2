<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generador de Fixtures</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    .container { max-width: 800px; margin: 0 auto; }
    .form-row { margin-bottom: 10px; }
    label { display: block; margin-bottom: 4px; }
    input, select { width: 100%; padding: 6px; box-sizing: border-box; }
    button { padding: 8px 16px; margin-top: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #f0f0f0; }
    #results { max-height: 500px; overflow-y: auto; }
  </style>
  <!-- Librerías para PDF (no requieren instalación) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.debug.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

</head>
<body>
  <div class="container">
    <h1>Generador de Fixtures Deportivos</h1>
    <p>Selecciona un archivo CSV con tus equipos y configura los parámetros para generar el calendario.</p>
    <div class="form-row">
      <label for="csvFileInput">Archivo CSV de equipos (formato: ZONA;NOMBRE_EQUIPO por fila):</label>
      <input type="file" id="csvFileInput" accept=".csv">
    </div>
    <div class="form-row">
      <label for="systemSelect">Sistema de competencia:</label>
      <select id="systemSelect">
        <option value="8x3">8x3 (round-robin por zonas)</option>
        <option value="8x3_complete_24">8x3 completo (24 equipos)</option>
        <option value="8x3_complete_23">8x3 completo (23 equipos)</option>
        <option value="8x3_complete_22">8x3 completo (22 equipos)</option>
        <option value="4x6">4x6 (round-robin por zona con cruces)</option>
      </select>
    </div>
    <div class="form-row">
      <label for="homeAndAway">Ida y vuelta (solo para 8x3 por zonas):</label>
      <select id="homeAndAway">
        <option value="no">No</option>
        <option value="yes">Sí</option>
      </select>
    </div>
    <div class="form-row">
      <label for="daysInput">Cantidad de días:</label>
      <input type="number" id="daysInput" value="5" min="1">
    </div>
    <div class="form-row">
      <label for="fieldsInput">Cantidad de canchas:</label>
      <input type="number" id="fieldsInput" value="2" min="1">
    </div>
    <div class="form-row">
      <label for="matchDurationInput">Duración de cada partido (minutos):</label>
      <input type="number" id="matchDurationInput" value="40" min="1">
    </div>
    <div class="form-row">
      <label for="restInput">Descanso entre partidos (minutos):</label>
      <input type="number" id="restInput" value="10" min="0">
    </div>
    <div class="form-row">
      <label>Configuración diaria (horario y pausa al mediodía):</label>
      <p style="font-size: 0.9em;">
        Puedes definir un horario general o configurar día por día. Si no se define una configuración específica para un día,
        se usará la configuración general.
      </p>
      <div class="form-row">
        <label for="startTimeInput">Hora inicio general:</label>
        <input type="time" id="startTimeInput" value="09:00">
      </div>
      <div class="form-row">
        <label for="endTimeInput">Hora fin general:</label>
        <input type="time" id="endTimeInput" value="20:00">
      </div>
      <div class="form-row">
        <label>Pausa al mediodía general:</label>
        <div style="display:flex; align-items:center; gap:5px;">
          <input type="time" id="breakStartInput" value="12:00">
          <span>a</span>
          <input type="time" id="breakEndInput" value="14:00">
        </div>
      </div>
      <div class="form-row">
        <label for="useCustomDailyConfig">
          <input type="checkbox" id="useCustomDailyConfig">
          Usar configuración específica día por día
        </label>
      </div>
      <div id="dailyConfigContainer"></div>
    </div>
    <button id="generateBtn">Generar Fixture</button>
    <div id="results"></div>
    <div id="dailySchedules"></div>
    <div id="exportPdfContainer" class="form-row" style="display:none; margin-top:10px;">
      <button id="downloadPdfBtn" type="button">Descargar fixture en PDF</button>
    </div>
  </div>

  <script>
  let lastSchedule = null;
  // Utilidades de tiempo
  function timeToMinutes(str) {
    const [h, m] = str.split(':').map(Number);
    return (h * 60) + m;
  }

  function minutesToTime(mins) {
    const h = Math.floor(mins / 60);
    const m = mins % 60;
    const hh = h.toString().padStart(2, '0');
    const mm = m.toString().padStart(2, '0');
    return `${hh}:${mm}`;
  }

  // Procesar CSV
  function processCSV(text) {
    const lines = text.split(/\r?\n/).map(l => l.trim()).filter(l => l);
    const zones = {};
    for (const line of lines) {
      const parts = line.split(';');
      if (parts.length < 2) continue;
      const zone = parts[0].trim();
      const team = parts[1].trim();
      if (!zone || !team) continue;
      if (!zones[zone]) zones[zone] = [];
      zones[zone].push(team);
    }
    const zonesKeys = Object.keys(zones);
    if (zonesKeys.length === 0) {
      throw new Error('No se encontraron zonas en el CSV. Asegúrate de que tenga formato ZONA;EQUIPO por fila.');
    }

    const teamsByZone = zonesKeys.reduce((acc, z) => {
      acc[z] = zones[z];
      return acc;
    }, {});
    return teamsByZone;
  }

  // Generar combinaciones (fixtures) para round-robin
  function roundRobin(teams) {
    const n = teams.length;
    if (n < 2) return [];

    if (n % 2 === 1) {
      teams = teams.slice();
      teams.push(null);
    }
    const rounds = [];
    const numRounds = teams.length - 1;
    const half = teams.length / 2;
    const arr = teams.slice();
    for (let r = 0; r < numRounds; r++) {
      const round = [];
      for (let i = 0; i < half; i++) {
        const t1 = arr[i];
        const t2 = arr[arr.length - 1 - i];
        if (t1 && t2) {
          round.push([t1, t2]);
        }
      }
      rounds.push(round);
      const fixed = arr[0];
      const rest = arr.slice(1);
      rest.unshift(rest.pop());
      arr.splice(0, arr.length, fixed, ...rest);
    }
    return rounds;
  }

  function generateFixture8x3(teamsByZone, days, fields, matchDuration, rest, dailyConfigs, homeAndAway) {
    const basicFieldLabels = ['C1', 'C2', 'C3', 'C4', 'C5'];
    const fieldLabels = basicFieldLabels.slice(0, fields);

    const allMatches = [];
    const zoneNames = Object.keys(teamsByZone).sort();

    zoneNames.forEach(zoneName => {
      const teams = teamsByZone[zoneName];
      if (teams.length !== 3) {
        console.warn(`Zona ${zoneName} no tiene exactamente 3 equipos, se ignora en el formato 8x3.`);
        return;
      }
      let rounds = roundRobin(teams.slice());
      if (homeAndAway === 'yes') {
        const secondLeg = rounds.map(round =>
          round.map(([home, away]) => [away, home])
        );
        rounds = rounds.concat(secondLeg);
      }
      let matchNo = allMatches.length + 1;
      rounds.forEach((round, roundIndex) => {
        round.forEach(pair => {
          const [home, away] = pair;
          allMatches.push({
            no: matchNo++,
            phase: `Zona ${zoneName}`,
            zone: zoneName,
            home,
            away,
            round: roundIndex + 1
          });
        });
      });
    });

    const scheduled = assignMatchesToDays(allMatches, days, fields, matchDuration, rest, dailyConfigs);

    return scheduled;
  }

  function generateFixture8x3Complete(teamsByZone, days, fields, matchDuration, rest, dailyConfigs, totalTeams) {
    const fullTeams = Object.values(teamsByZone).flat();
    if (fullTeams.length !== totalTeams) {
      throw new Error(`Se esperaban ${totalTeams} equipos en total, pero el CSV tiene ${fullTeams.length}.`);
    }

    const basicFieldLabels = ['C1', 'C2', 'C3', 'C4'];
    const fieldLabels = basicFieldLabels.slice(0, fields);

    const zoneNames = Object.keys(teamsByZone).sort();
    const matches = [];

    zoneNames.forEach(zoneName => {
      const teams = teamsByZone[zoneName];
      if (teams.length !== 3) {
        console.warn(`Zona ${zoneName} no tiene exactamente 3 equipos, se ignora en el formato 8x3 completo.`);
        return;
      }
      const [t1, t2, t3] = teams;
      matches.push({ phase: `Zona ${zoneName}`, zone: zoneName, home: t1, away: t2 });
      matches.push({ phase: `Zona ${zoneName}`, zone: zoneName, home: t3, away: t1 });
      matches.push({ phase: `Zona ${zoneName}`, zone: zoneName, home: t2, away: t3 });
    });

    const scheduleMap = analyzeScheduleTemplate(matches.length, days, fields, matchDuration, rest, dailyConfigs);

    const fullSchedule = generateFullScheduleFromTemplate(
      matches,
      scheduleMap,
      days,
      fields,
      matchDuration,
      rest,
      dailyConfigs
    );

    const enrichedSchedule = assignPositionsForElimination(fullSchedule, totalTeams);

    return enrichedSchedule;
  }

  function generateFixture8x3Complete24(teamsByZone, days, fields, matchDuration, rest, dailyConfigs) {
    return generateFixture8x3Complete(teamsByZone, days, fields, matchDuration, rest, dailyConfigs, 24);
  }

  function generateFixture8x3Complete23(teamsByZone, days, fields, matchDuration, rest, dailyConfigs) {
    return generateFixture8x3Complete(teamsByZone, days, fields, matchDuration, rest, dailyConfigs, 23);
  }

  function generateFixture8x3Complete22(teamsByZone, days, fields, matchDuration, rest, dailyConfigs) {
    return generateFixture8x3Complete(teamsByZone, days, fields, matchDuration, rest, dailyConfigs, 22);
  }

  function analyzeScheduleTemplate(numMatches, days, fields, matchDuration, rest, dailyConfigs) {
    return assignMatchesToDays(
      Array.from({ length: numMatches }, (_, i) => ({ no: i + 1 })),
      days,
      fields,
      matchDuration,
      rest,
      dailyConfigs
    );
  }

  function generateFullScheduleFromTemplate(templateSchedule, matches, days, fields, matchDuration, rest, dailyConfigs) {
    const fullFields = ['C1', 'C2', 'C3', 'C4'];
    const fieldLabels = fullFields.slice(0, fields);

    const fullSchedule = [];

    for (let day = 1; day <= days; day++) {
      const config = dailyConfigs[day] || dailyConfigs.default;
      let currentTime = config.start;
      const endTime = config.end;

      const breakStart = config.breakStart;
      const breakEnd = config.breakEnd;

      while (currentTime + matchDuration <= endTime) {
        if (breakStart != null && breakEnd != null && currentTime >= breakStart && currentTime < breakEnd) {
          currentTime = breakEnd;
          continue;
        }

        for (let f = 0; f < fields; f++) {
          const field = fieldLabels[f];
          const matchTemplate = templateSchedule.find(m => !m.assigned);
          if (!matchTemplate) {
            return assignMatchesToDays(matches, days, fields, matchDuration, rest, dailyConfigs);
          }
          matchTemplate.assigned = true;
        }

        currentTime += matchDuration + rest;
      }
    }

    throw new Error('No se pudo acomodar la fase regular dentro de los parámetros given.');
  }

  function assignPositionsForElimination(schedule, totalTeams) {
    return schedule;
  }

  function assignMatchesToDays(matches, days, fields, matchDuration, rest, dailyConfigs) {
    const basicFieldLabels = ['C1', 'C2', 'C3', 'C4', 'C5'];
    const fieldLabels = basicFieldLabels.slice(0, fields);

    const scheduled = [];
    let matchIndex = 0;
    let currentMatchNumber = 1;

    outerLoop:
    for (let day = 1; day <= days; day++) {
      const config = dailyConfigs[day] || dailyConfigs.default;
      let currentTime = config.start;
      const endTime = config.end;
      const breakStart = config.breakStart;
      const breakEnd = config.breakEnd;

      while (currentTime + matchDuration <= endTime) {
        if (breakStart != null && breakEnd != null && currentTime >= breakStart && currentTime < breakEnd) {
          currentTime = breakEnd;
          continue;
        }
        for (let f = 0; f < fields; f++) {
          if (matchIndex >= matches.length) {
            break outerLoop;
          }
          const match = matches[matchIndex++];
          scheduled.push({
            ...match,
            no: match.no !== undefined ? match.no : currentMatchNumber++,
            day,
            time: minutesToTime(currentTime),
            field: fieldLabels[f] || `C${f + 1}`
          });
        }
        currentTime += matchDuration + rest;
      }
    }

    return scheduled;
  }

  function generateFixture4x6(teamsByZone, days, fields, matchDuration, rest, dailyConfigs) {
    const basicFieldLabels = ['C1', 'C2', 'C3', 'C4'];
    const fieldLabels = basicFieldLabels.slice(0, fields);

    const allMatches = [];
    const zoneNames = Object.keys(teamsByZone).sort();

    zoneNames.forEach(zoneName => {
      const teams = teamsByZone[zoneName];
      if (teams.length !== 6) {
        console.warn(`Zona ${zoneName} no tiene exactamente 6 equipos, se ignora en el formato 4x6.`);
        return;
      }
      const rounds = roundRobin(teams.slice());
      let matchNo = allMatches.length + 1;
      rounds.forEach((round, roundIndex) => {
        round.forEach(pair => {
          const [home, away] = pair;
          allMatches.push({
            no: matchNo++,
            phase: `Zona ${zoneName}`,
            zone: zoneName,
            home,
            away,
            round: roundIndex + 1
          });
        });
      });
    });

    const scheduled = assignMatchesToDays(allMatches, days, fields, matchDuration, rest, dailyConfigs);

    return scheduled;
  }

  function renderSchedule(schedule) {
    const container = document.getElementById('results');
    const dailyContainer = document.getElementById('dailySchedules');
    const exportPdfContainer = document.getElementById('exportPdfContainer');

    if (!schedule || schedule.length === 0) {
      container.innerHTML = '<p>No se generó ningún fixture.</p>';
      if (dailyContainer) dailyContainer.innerHTML = '';
      if (exportPdfContainer) exportPdfContainer.style.display = 'none';
      lastSchedule = null;
      return;
    }

    lastSchedule = schedule;

    const showPhase = 'phase' in schedule[0];
    const showZone  = 'zone'  in schedule[0];
    const showRound = 'round' in schedule[0];
    const showNo    = 'no'    in schedule[0];

    let html = '<table><thead><tr>';
    if (showNo) html += '<th>No</th>';
    html += '<th>Día</th><th>Hora</th><th>Cancha</th>';
    html += '<th>' + (showPhase ? 'Fase/Zona' : (showZone ? 'Zona' : 'Fase')) + '</th>';
    html += '<th>Local</th><th>Visitante</th>';
    if (showRound) html += '<th>Ronda</th>';
    html += '</tr></thead><tbody>';

    schedule.forEach(m => {
      html += '<tr>';
      if (showNo) html += `<td>${m.no !== undefined ? m.no : ''}</td>`;
      html += `<td>${m.day}</td><td>${m.time}</td><td>${m.field}</td>`;
      if (showPhase) {
        html += `<td>${m.phase}</td>`;
      } else if (showZone) {
        html += `<td>${m.zone}</td>`;
      } else {
        html += '<td></td>';
      }
      html += `<td>${m.home}</td><td>${m.away}</td>`;
      if (showRound) html += `<td>${m.round !== undefined ? m.round : ''}</td>`;
      html += '</tr>';
    });

    html += '</tbody></table>';
    container.innerHTML = html;

    renderDailySchedules(schedule);

    if (exportPdfContainer) {
      exportPdfContainer.style.display = 'block';
    }
  }

  /**
   * Render schedule grouped by day below the main table. Displays tables two per row for readability.
   * @param {Array} schedule - List of scheduled matches with properties day, time, field, phase/zone, home, away, no etc.
   */
  function renderDailySchedules(schedule) {
    const container = document.getElementById('dailySchedules');
    const byDay = {};
    schedule.forEach(m => {
      if (!byDay[m.day]) byDay[m.day] = [];
      byDay[m.day].push(m);
    });
    const days = Object.keys(byDay).map(Number).sort((a, b) => a - b);
    const showNoDaily = schedule.some(m => m.no !== undefined);
    let html = '';

    for (let i = 0; i < days.length; i += 2) {
      html += '<div style="display:flex; gap:20px; margin-top:20px;">';

      [days[i], days[i+1]].forEach(day => {
        if (day === undefined) return;
        const dayMatches = byDay[day];
        html += '<div style="flex:1;">';
        html += `<h3>Día ${day}</h3>`;
        html += '<table><thead><tr>';
        if (showNoDaily) html += '<th>No</th>';
        html += '<th>Hora</th><th>Cancha</th><th>Fase/Zona</th><th>Local</th><th>Visitante</th><th>Ronda</th></tr></thead><tbody>';

        dayMatches.forEach(m => {
          html += '<tr>';
          if (showNoDaily) html += `<td>${m.no !== undefined ? m.no : ''}</td>`;
          html += `<td>${m.time}</td><td>${m.field}</td>`;
          html += `<td>${m.phase || m.zone || ''}</td>`;
          html += `<td>${m.home}</td><td>${m.away}</td>`;
          html += `<td>${m.round !== undefined ? m.round : ''}</td>`;
          html += '</tr>';
        });

        html += '</tbody></table>';
        html += '</div>';
      });

      html += '</div>';
    }

    container.innerHTML = html;
  }

  function buildDailyConfigs(days, useCustom, defaultStart, defaultEnd, defaultBreakStart, defaultBreakEnd) {
    const configs = {};
    configs.default = {
      start: defaultStart,
      end: defaultEnd,
      breakStart: defaultBreakStart,
      breakEnd: defaultBreakEnd
    };
    if (!useCustom) return configs;

    for (let day = 1; day <= days; day++) {
      const startInput = document.getElementById(`day${day}Start`);
      const endInput = document.getElementById(`day${day}End`);
      const breakStartInput = document.getElementById(`day${day}BreakStart`);
      const breakEndInput = document.getElementById(`day${day}BreakEnd`);

      let start = defaultStart;
      let end = defaultEnd;
      let breakStart = defaultBreakStart;
      let breakEnd = defaultBreakEnd;

      if (startInput && startInput.value) start = timeToMinutes(startInput.value);
      if (endInput && endInput.value) end = timeToMinutes(endInput.value);
      if (breakStartInput && breakStartInput.value) breakStart = timeToMinutes(breakStartInput.value);
      if (breakEndInput && breakEndInput.value) breakEnd = timeToMinutes(breakEndInput.value);

      configs[day] = { start, end, breakStart, breakEnd };
    }

    return configs;
  }

  function setupDailyConfigUI(days, useCustom, defaultStartStr, defaultEndStr, defaultBreakStartStr, defaultBreakEndStr) {
    const container = document.getElementById('dailyConfigContainer');
    container.innerHTML = '';

    if (!useCustom) return;

    for (let day = 1; day <= days; day++) {
      const dayDiv = document.createElement('div');
      dayDiv.className = 'form-row';
      dayDiv.innerHTML = `
        <fieldset style="border:1px solid #ccc; padding:10px;">
          <legend>Día ${day}</legend>
          <label>Hora inicio:</label>
          <input type="time" id="day${day}Start" value="${defaultStartStr}">
          <label>Hora fin:</label>
          <input type="time" id="day${day}End" value="${defaultEndStr}">
          <label>Pausa al mediodía:</label>
          <div style="display:flex; align-items:center; gap:5px;">
            <input type="time" id="day${day}BreakStart" value="${defaultBreakStartStr}">
            <span>a</span>
            <input type="time" id="day${day}BreakEnd" value="${defaultBreakEndStr}">
          </div>
        </fieldset>
      `;
      container.appendChild(dayDiv);
    }
  }

  document.getElementById('useCustomDailyConfig').addEventListener('change', function() {
    const days = parseInt(document.getElementById('daysInput').value, 10);
    const defaultStartStr = document.getElementById('startTimeInput').value;
    const defaultEndStr = document.getElementById('endTimeInput').value;
    const defaultBreakStartStr = document.getElementById('breakStartInput').value;
    const defaultBreakEndStr = document.getElementById('breakEndInput').value;

    setupDailyConfigUI(
      days,
      this.checked,
      defaultStartStr,
      defaultEndStr,
      defaultBreakStartStr,
      defaultBreakEndStr
    );
  });

  document.getElementById('daysInput').addEventListener('change', function() {
    const useCustom = document.getElementById('useCustomDailyConfig').checked;
    const days = parseInt(this.value, 10);
    const defaultStartStr = document.getElementById('startTimeInput').value;
    const defaultEndStr = document.getElementById('endTimeInput').value;
    const defaultBreakStartStr = document.getElementById('breakStartInput').value;
    const defaultBreakEndStr = document.getElementById('breakEndInput').value;

    setupDailyConfigUI(
      days,
      useCustom,
      defaultStartStr,
      defaultEndStr,
      defaultBreakStartStr,
      defaultBreakEndStr
    );
  });

  document.getElementById('generateBtn').addEventListener('click', function() {
    const fileInput = document.getElementById('csvFileInput');
    const system = document.getElementById('systemSelect').value;
    const days = parseInt(document.getElementById('daysInput').value, 10);
    const fields = parseInt(document.getElementById('fieldsInput').value, 10);
    const matchDuration = parseInt(document.getElementById('matchDurationInput').value, 10);
    const rest = parseInt(document.getElementById('restInput').value, 10);
    const homeAndAway = document.getElementById('homeAndAway').value;
    const startTimeStr = document.getElementById('startTimeInput').value;
    const endTimeStr = document.getElementById('endTimeInput').value;
    const breakStartStr = document.getElementById('breakStartInput').value;
    const breakEndStr = document.getElementById('breakEndInput').value;

    if (!fileInput.files || fileInput.files.length === 0) {
      alert('Por favor, selecciona un archivo CSV.');
      return;
    }

    const file = fileInput.files[0];

    const defaultStart = timeToMinutes(startTimeStr);
    const defaultEnd = timeToMinutes(endTimeStr);
    const defaultBreakStart = timeToMinutes(breakStartStr);
    const defaultBreakEnd = timeToMinutes(breakEndStr);

    const useCustomDailyConfig = document.getElementById('useCustomDailyConfig').checked;
    const dailyConfigs = buildDailyConfigs(
      days,
      useCustomDailyConfig,
      defaultStart,
      defaultEnd,
      defaultBreakStart,
      defaultBreakEnd
    );

    const reader = new FileReader();
    reader.onload = function(e) {
      const text = e.target.result;
      try {
        const teams = processCSV(text);
        let schedule;
        if (system === '8x3') {
          schedule = generateFixture8x3(
            teams,
            days,
            fields,
            matchDuration,
            rest,
            dailyConfigs,
            homeAndAway
          );
        } else if (system === '8x3_complete_24') {
          schedule = generateFixture8x3Complete24(
            teams,
            days,
            fields,
            matchDuration,
            rest,
            dailyConfigs
          );
        } else if (system === '8x3_complete_23') {
          schedule = generateFixture8x3Complete23(
            teams,
            days,
            fields,
            matchDuration,
            rest,
            dailyConfigs
          );
        } else if (system === '8x3_complete_22') {
          schedule = generateFixture8x3Complete22(
            teams,
            days,
            fields,
            matchDuration,
            rest,
            dailyConfigs
          );
        } else if (system === '4x6') {
          schedule = generateFixture4x6(
            teams,
            days,
            fields,
            matchDuration,
            rest,
            dailyConfigs
          );
        } else {
          throw new Error('Sistema de competencia no soportado.');
        }
        renderSchedule(schedule);
      } catch (err) {
        console.error(err);
        alert('Error al generar el fixture: ' + err.message);
      }
    };
    reader.readAsText(file);
  });

  // Generar PDF profesional (azul/celeste, legible en B/N)
  function generatePdfFromSchedule() {
    if (!lastSchedule || !lastSchedule.length) {
      alert("Primero generá un fixture.");
      return;
    }

    var doc = new jsPDF('p', 'mm', 'a4');
    var marginLeft = 14;
    var currentY = 20;

    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.setTextColor(13, 71, 161);
    doc.text("Fixture del Torneo", marginLeft, currentY);

    currentY += 8;
    doc.setFontSize(11);
    doc.setFont("helvetica", "normal");
    doc.setTextColor(0, 0, 0);

    var today = new Date();
    var dateStr = today.toLocaleDateString("es-AR");
    var systemSelect = document.getElementById("systemSelect");
    var systemText = systemSelect ? systemSelect.options[systemSelect.selectedIndex].text : "";
    doc.text("Sistema: " + systemText, marginLeft, currentY);
    currentY += 5;
    doc.text("Generado el: " + dateStr, marginLeft, currentY);
    currentY += 8;

    var schedule = lastSchedule;
    var showPhase = 'phase' in schedule[0];
    var showZone  = 'zone'  in schedule[0];
    var showRound = 'round' in schedule[0];
    var showNo    = 'no'    in schedule[0];

    var daysMap = {};
    schedule.forEach(function(m) {
      if (!daysMap[m.day]) daysMap[m.day] = [];
      daysMap[m.day].push(m);
    });

    var orderedDays = Object.keys(daysMap).sort(function(a,b){return a-b;});

    orderedDays.forEach(function(day, idx) {
      var matches = daysMap[day];

      if (idx > 0) {
        doc.addPage();
        currentY = 20;
      }

      doc.setFont("helvetica", "bold");
      doc.setFontSize(14);
      doc.setTextColor(25, 118, 210);
      doc.text("Día " + day, marginLeft, currentY);
      currentY += 6;

      var headers = [];
      if (showNo) headers.push("No");
      headers.push("Hora", "Cancha");
      headers.push(showPhase ? "Fase/Zona" : (showZone ? "Zona" : "Fase"));
      headers.push("Local", "Visitante");
      if (showRound) headers.push("Ronda");

      var body = matches.map(function(m) {
        var row = [];
        if (showNo) row.push(m.no !== undefined ? m.no : "");
        row.push(m.time, m.field);
        var phaseVal = "";
        if (showPhase) phaseVal = m.phase || "";
        else if (showZone) phaseVal = m.zone || "";
        row.push(phaseVal);
        row.push(m.home || "", m.away || "");
        if (showRound) row.push(m.round !== undefined ? m.round : "");
        return row;
      });

      doc.autoTable({
        startY: currentY,
        head: [headers],
        body: body,
        theme: "grid",
        styles: {
          font: "helvetica",
          fontSize: 9,
          cellPadding: 2,
          lineWidth: 0.1,
          lineColor: [120, 144, 156]
        },
        headStyles: {
          fillColor: [13, 71, 161],
          textColor: [255, 255, 255],
          fontStyle: "bold"
        },
        alternateRowStyles: {
          fillColor: [227, 242, 253]
        },
        tableLineColor: [120, 144, 156],
        tableLineWidth: 0.1,
        margin: { left: marginLeft, right: 14 }
      });
    });

    doc.save("fixture.pdf");
  }

  document.addEventListener("DOMContentLoaded", function() {
    var pdfBtn = document.getElementById("downloadPdfBtn");
    if (pdfBtn) {
      pdfBtn.addEventListener("click", generatePdfFromSchedule);
    }
  });

  </script>
</body>
</html>
